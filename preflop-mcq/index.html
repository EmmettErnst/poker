<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Preflop MCQ Trainer</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b0f14; color:#e8eef7; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 8px; font-size: 24px; }
    .muted { opacity:.75; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    a { color:#9dd6ff; text-decoration:none; }
    a:hover { text-decoration:underline; }

    .cardrow { display:flex; gap:16px; margin: 16px 0 8px; align-items:center; flex-wrap: wrap; }
    .playing-card{
      width: 110px; height: 150px; border-radius: 14px;
      background: #f8fbff; color:#111; box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:flex; flex-direction:column; justify-content:space-between; padding: 10px;
      border: 1px solid rgba(255,255,255,.14);
      user-select:none;
    }
    .corner { font-weight: 800; font-size: 22px; line-height: 1; }
    .suit { font-size: 26px; opacity:.9; }
    .center { display:flex; justify-content:center; align-items:center; font-size: 54px; font-weight: 900; }
    .red { color:#c81d25; }
    .black { color:#111; }

    .panel{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 16px;
      margin-top: 14px;
    }
    .row { display:flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    label { display:block; font-size: 12px; opacity:.85; margin: 0 0 6px; }
    button, select {
      border-radius: 12px; border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08); color:#e8eef7;
      padding: 10px 12px; font-size: 14px;
      outline: none;
    }
    button { cursor:pointer; font-weight: 700; }
    button:hover { background: rgba(255,255,255,.12); }

    .pill{
      display:inline-flex; gap: 8px; align-items:center;
      padding: 8px 10px; border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      margin-right: 8px;
      margin-top: 8px;
      font-size: 13px;
    }

    .choices{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }
    .choice{
      text-align:left;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      font-weight: 750;
    }
    .choice:disabled { cursor:not-allowed; opacity:.8; }
    .choice.correct { border-color: rgba(110,231,183,.9); }
    .choice.wrong { border-color: rgba(252,165,165,.9); }

    .result { margin-top: 12px; line-height: 1.45; }
    .good { color: #6ee7b7; }
    .bad  { color: #fca5a5; }
    .tiny { font-size: 12px; opacity:.8; margin-top: 10px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; padding: 2px 6px; border-radius: 8px; background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.10); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Preflop MCQ Trainer</h1>
        <div class="muted">Pick the right answer out of 8.</div>
      </div>
      <div class="muted">
        <a href="/">Back to Poker Hub</a>
      </div>
    </div>

    <div class="cardrow" id="cardRow"></div>

    <div class="panel">
      <div class="row">
        <div>
          <label for="mode">Mode</label>
          <select id="mode">
            <option value="rank" selected>Rank (1–169)</option>
            <option value="pct">Percentile (0–100, lower is better)</option>
          </select>
        </div>

        <button id="nextBtn">Next hand</button>
        <button id="resetBtn">Reset score</button>
      </div>

      <div class="result" id="prompt"></div>
      <div class="choices" id="choices"></div>

      <div class="result" id="result"></div>

      <div>
        <span class="pill">Hand label: <b id="handLabel">...</b></span>
        <span class="pill">Score: <b id="score">0</b></span>
        <span class="pill">Streak: <b id="streak">0</b></span>
        <span class="pill">Best streak: <b id="bestStreak">0</b></span>
      </div>

      <div class="tiny">
        Tips: press <span class="kbd">N</span> for next. Click an option to answer.
      </div>
    </div>
  </div>

  <script type="module">
    import { RANKINGS, buildIndex } from "./preflop_rankings_169.js";

    const { byCards: byHand } = buildIndex(RANKINGS);

    const RANK_VALUE = new Map([
      ["A",14],["K",13],["Q",12],["J",11],["T",10],
      ["9",9],["8",8],["7",7],["6",6],["5",5],["4",4],["3",3],["2",2]
    ]);

    const SUITS = [
      {c:"♠", color:"black", key:"s"},
      {c:"♥", color:"red",   key:"h"},
      {c:"♦", color:"red",   key:"d"},
      {c:"♣", color:"black", key:"c"},
    ];
    const RANKS = ["A","K","Q","J","T","9","8","7","6","5","4","3","2"];

    function makeDeck() {
      const deck = [];
      for (const r of RANKS) for (const s of SUITS) deck.push({rank:r, suit:s});
      return deck;
    }
    function randInt(n) { return Math.floor(Math.random() * n); }
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = randInt(i + 1);
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    function drawTwo() {
      const deck = makeDeck();
      const a = deck.splice(randInt(deck.length), 1)[0];
      const b = deck.splice(randInt(deck.length), 1)[0];
      return [a,b];
    }

    function toHandLabel(c1, c2) {
      const r1 = c1.rank, r2 = c2.rank;
      const v1 = RANK_VALUE.get(r1), v2 = RANK_VALUE.get(r2);
      if (r1 === r2) return r1 + r2;

      let hi = r1, lo = r2;
      if (v2 > v1) { hi = r2; lo = r1; }

      const suited = (c1.suit.key === c2.suit.key);
      return hi + lo + (suited ? "s" : "o");
    }

    function renderCard(card) {
      const isRed = card.suit.color === "red";
      const div = document.createElement("div");
      div.className = "playing-card";

      const top = document.createElement("div");
      top.className = "corner " + (isRed ? "red" : "black");
      top.innerHTML = `${card.rank}<div class="suit">${card.suit.c}</div>`;

      const mid = document.createElement("div");
      mid.className = "center " + (isRed ? "red" : "black");
      mid.textContent = card.suit.c;

      const bot = document.createElement("div");
      bot.className = "corner " + (isRed ? "red" : "black");
      bot.style.transform = "rotate(180deg)";
      bot.innerHTML = `${card.rank}<div class="suit">${card.suit.c}</div>`;

      div.appendChild(top);
      div.appendChild(mid);
      div.appendChild(bot);
      return div;
    }

    // UI
    const cardRow = document.getElementById("cardRow");
    const choicesEl = document.getElementById("choices");
    const resultEl = document.getElementById("result");
    const promptEl = document.getElementById("prompt");
    const handLabelEl = document.getElementById("handLabel");
    const scoreEl = document.getElementById("score");
    const streakEl = document.getElementById("streak");
    const bestStreakEl = document.getElementById("bestStreak");
    const modeEl = document.getElementById("mode");
    const nextBtn = document.getElementById("nextBtn");
    const resetBtn = document.getElementById("resetBtn");

    // State
    let current = null; // {cards,label,data,mode,correctAnswer,options[]}
    let locked = false;
    let score = 0, streak = 0, bestStreak = 0;

    function setStats() {
      scoreEl.textContent = String(score);
      streakEl.textContent = String(streak);
      bestStreakEl.textContent = String(bestStreak);
    }

    function fmtOption(mode, v) {
      return mode === "rank" ? `#${v}` : `${v}`;
    }

    function buildOptions(mode, actualRank, actualPct) {
      const correct = (mode === "rank") ? actualRank : actualPct;
      const min = (mode === "rank") ? 1 : 0;
      const max = (mode === "rank") ? 169 : 100;

      const opts = new Set([correct]);

      // Mix: nearby numbers + random numbers
      const nearbySteps = (mode === "rank")
        ? [1,2,3,5,7,10,15,20,25,30]
        : [1,2,3,4,5,7,10,12,15,20];

      while (opts.size < 6) {
        const step = nearbySteps[randInt(nearbySteps.length)];
        const sign = (Math.random() < 0.5) ? -1 : 1;
        let v = correct + sign * step;
        v = Math.max(min, Math.min(max, v));
        opts.add(v);
      }

      while (opts.size < 8) {
        const v = min + randInt(max - min + 1);
        opts.add(v);
      }

      const arr = shuffle(Array.from(opts));
      return { correct, arr };
    }

    function showPrompt(mode) {
      if (mode === "rank") {
        promptEl.innerHTML = `<div class="muted">Pick the correct <b>rank</b> (1 is best, 169 is worst).</div>`;
      } else {
        promptEl.innerHTML = `<div class="muted">Pick the correct <b>percentile</b> (0 is best, 100 is worst).</div>`;
      }
    }

    function newHand() {
      locked = false;
      resultEl.innerHTML = "";
      choicesEl.innerHTML = "";

      const mode = modeEl.value;

      const cards = drawTwo();
      const label = toHandLabel(cards[0], cards[1]);
      const data = byHand.get(label) || null;

      current = { cards, label, data, mode };

      cardRow.innerHTML = "";
      cardRow.appendChild(renderCard(cards[0]));
      cardRow.appendChild(renderCard(cards[1]));
      handLabelEl.textContent = label + (data ? "" : " (not found)");

      showPrompt(mode);

      if (!data) {
        resultEl.innerHTML = `<div class="bad">This hand label (${label}) was not found in the rankings map.</div>`;
        locked = true;
        return;
      }

      const actualRank = Number(String(data.Rank).replace("%","").trim());
      const actualPct  = Number(String(data.Percentile).replace("%","").trim());

      const { correct, arr } = buildOptions(mode, actualRank, actualPct);

      current.actualRank = actualRank;
      current.actualPct = actualPct;
      current.correctAnswer = correct;
      current.options = arr;

      for (const v of arr) {
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.type = "button";
        btn.textContent = (mode === "rank") ? `Rank ${fmtOption(mode, v)}` : `Percentile ${fmtOption(mode, v)}`;
        btn.addEventListener("click", () => choose(v, btn));
        choicesEl.appendChild(btn);
      }
    }

    function choose(value, btnEl) {
      if (!current || locked) return;
      locked = true;

      const { mode, correctAnswer, actualRank, actualPct } = current;
      const diff = Math.abs(correctAnswer - value);
      const correct = (value === correctAnswer);

      if (correct) {
        score += 1;
        streak += 1;
        if (streak > bestStreak) bestStreak = streak;
      } else {
        streak = 0;
      }
      setStats();

      // Mark buttons
      for (const child of choicesEl.querySelectorAll("button.choice")) {
        const txt = child.textContent || "";
        const num = Number(txt.replace(/[^\d]/g, ""));
        if (num === correctAnswer) child.classList.add("correct");
        child.disabled = true;
      }
      if (!correct) btnEl.classList.add("wrong");

      let directionLine = "";
      if (mode === "pct") {
        const signed = correctAnswer - value; // positive => actual is worse than guessed
        if (signed === 0) {
          directionLine = "Exactly right.";
        } else if (signed > 0) {
          directionLine = `The hand was <b>${signed}</b> points <b>worse</b> than you predicted.`;
        } else {
          directionLine = `The hand was <b>${Math.abs(signed)}</b> points <b>better</b> than you predicted.`;
        }
      }

      const cls = correct ? "good" : "bad";
      const headerLabel = (mode === "rank") ? "Actual rank" : "Actual percentile";

      resultEl.innerHTML = `
        <div class="${cls}">
          ${headerLabel}: <b>${correctAnswer}</b> (you chose <b>${value}</b>${mode === "rank" ? `, off by <b>${diff}</b>` : ""})
          ${mode === "pct" ? `<div class="muted">${directionLine}</div>` : ""}
        </div>
        <div class="muted">
          Rank: <b>#${actualRank}</b> |
          Percentile: <b>${actualPct}</b> |
          Sklansky group: <b>${current.data["Sklansky Group"]}</b> |
          Win: <b>${current.data["% win"]}</b> |
          Tie: <b>${current.data["% tie"]}</b>
        </div>
      `;
    }

    function resetScore() {
      score = 0; streak = 0; bestStreak = 0;
      setStats();
      resultEl.innerHTML = "";
      locked = false;
    }

    nextBtn.addEventListener("click", newHand);
    resetBtn.addEventListener("click", resetScore);
    modeEl.addEventListener("change", () => newHand());

    document.addEventListener("keydown", (e) => {
      if (e.key.toLowerCase() === "n") newHand();
    });

    setStats();
    newHand();
  </script>
</body>
</html>
